name: Node.js CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies and build
        run: |
          npm ci
          cd client
          npm ci
          npm run build
          cd ..
        shell: bash

      - name: Restart PM2 and Nginx
        run: |
          if pm2 list | grep -q "online"; then
            echo "Stopping all PM2 processes..."
            pm2 stop all
          else
            echo "No running PM2 processes to stop."
          fi
          echo "Starting all PM2 processes..."
          pm2 start all
          pm2 save
          echo "Restarting Nginx..."
          sudo service nginx restart
        shell: bash
